---
title: 'Тестовое задание: Playrix'
author: "Адамович Алексей"
output: html_document
---
***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(sandwich)
library(lmtest)
library(ggplot2)
```

## Содержание анализа: {#start}

##### [1. Краткое содержание работы](#point1)
##### [2. Обработка исходных данных](#point2)
##### [3. Исследование существующих и добавление новых переменных](#point3)
##### [4. Построение модели](#point4)
##### [5. Интерпритация коэффициентов, влияющих на среднее количество удалений заказов](#point5)

***
***

### 1. Краткое изложение работы {#point1}

В данной задаче был поставлен вопрос: *"заказы с какими продуктами игроки чаще удаляют на карте заказов и почему?"*. Для ответа были использованы игровая статистика, описание товаров в игре, а также информация, полученная в процессе самой игры.

Исходные сырые данные были импортированы в Excel и приобразованы в табличный вид. Затем импортированы в R для дальнейших преобразований и анализа. Были проанализированы имеющиеся переменные и созданы новые производные переменные.

Был проведен *анализ по данным, собранных вручную из игры*, в результате которого выяснилось, что цена продажи в амбаре прямопропорциональна вознаграждению за заказ.

В качестве характеристики, определяющей частосту удаления, была выбрана величина *"среднее количество удалений за уровень"* (равная "сумма удалений продукта за все время" делить на "количество уровней, когда товар был доступен").

Для описания данной переменной была построена модель, в которую были включены переменные, описывающие:

1. Как долго доступен товар в игре. 
2. Тип продукта (семена / товар с фабрик)
3. Цена продажи в амбаре (высоко коррелирующая с ценой покупки за кэш)

Остальные переменные оказались незначимы.

В итоге мы получили следующий **ответ на вопрос:** *чаще удаляются заказы, которые содержат товары со следующими характеристками:*

1. недавно были открыты в игре
2. являются товарами с фабрик
3. а) для товаров с фабрик: низкое вознагрождение за заказ (объясняемое низкой ценой продажи товара в амбаре)  
   б) для семян: более высокая стоимость покупки за кэш. 

более подробное влияние данных характеристик изложено в [финальном пунке](#point5)

### 2. Обработка исходных данных {#point2}
[начало](#start)

Исходные файлы были импортированы в Excel, трансформированы в табличный вид и импортированы в файл "database.scv". В результате из предоставленных данных была получена таблица со следующими переменными:

+ **lvl.min** - нижния граница группы уровней;
+ **lvl.max** - верхняя граница группы уровней;
+ **product** - id товара;
+ **name** - название товара;
+ **type** - тип товара
    + seeds - семена
    + manufactured_goods - товары с фабрик
    + special_goods - товары из специальных зданий (слитки)
    + rare - редкие товары, описание которых отсутсвует
+ **refused** - кол-во удалённых заказов
+ **lvl.start** - уровень ввода в игре
+ **growth.time** - время роста(мин)
+ **sell.price** - стоимость продажи из амбара
+ **buy.price** - стоимость покупки за кэш


```{r, echo = TRUE}
df <- read.csv("database.csv", sep = ";", na.strings = "NA", colClasses = c(rep("numeric",2), rep("factor", 3), rep("numeric",4)))
str(df)
```

Было обноружено, что кроме семян и товаров с фабрик были удалены заказы с "неизвестными" продуктами, которые, как выяснилось, являлись либо слитками (товары из специальных зданий), либо иными редкими товарами.

```{r, echo = TRUE}
rare.refused <- filter(df, !(type %in% c("seeds", "manufactured_goods")))
rare.refused[, c("product", "type", "refused", "growth.time")]
df <- filter(df, (type %in% c("seeds", "manufactured_goods")))
```

Количество отказов по данным позициям составило `r formatC(round(sum(rare.refused$refused) / sum(df$refused) * 100, digits = 4), format = "f")`%, поэтому исключим данные позиции из дальнейшего анализа, оставив товары типа "seeds" и "manufactured_goods".

### 3. Исследование существующих и добавление новых переменных {#point3}
[начало](#start)

Далее было принято решение добавить несколько **новых переменных связанных с игровыми уровнями и типом продукта**:

1. *lvl.avg* - средний уровень в группе уровней
2. *availability* - доступен ли товар на данных уровнях
3. *avlbl.lvl.cnt* - кол-во уровней, на которых доступен товар, в текущей группе
4. *min.long.avlbl* - сколько уровней назад относительно минимального уровня группы появился товар
5. *max.long.avlbl* - сколько уровней назад относительно максимального уровня группы появился товар
6. *refused.per.lvl.in.group* - количество удалений заказов на количество уровней в группе, когда данный товар был доступен
7. *type.seeds* - (дамми-переменная") "1" - товар отновится к группе "Семена", 0 - товар отновится к группе "товары с фабрик"


```{r, echo = FALSE}
    df <- mutate(df, lvl.avg = as.factor(round((lvl.min + lvl.max)/2, 1)),
                availability = lvl.start <= lvl.max,
                avlbl.lvl.cnt = ifelse(availability, ifelse(lvl.min > lvl.start, lvl.max - lvl.min, lvl.max - lvl.start) + 1, 0),
                min.long.avlbl = ifelse(lvl.start > lvl.min, 0, lvl.min - lvl.start),
                max.long.avlbl = min.long.avlbl + avlbl.lvl.cnt,
                refused.per.lvl.in.group = ifelse(availability, refused / avlbl.lvl.cnt, refused),
                type.seeds = ifelse(type == "seeds", 1, 0)
    )
    select(df, name, type, type.seeds, lvl.min, lvl.max, lvl.start, availability, avlbl.lvl.cnt, min.long.avlbl, refused, refused.per.lvl.in.group)[c(219:224),]
```


#### Исследование переменных growth.time, sell.price и buy.price

##### a) growth.time

**growth.time** - показатель, который напрямую отображается в окне заказов при нажатии на товар. Априорно можно предположить, что большая его величина (при прочих равных) должа увеличить вероятность удаления заказа.

##### b) sell.price

Вручную была сделана выборка из 9 реальных игровых заказов

```{r, echo = TRUE}
orders <- read.csv("orders.csv", sep = ";", na.strings = "NA", colClasses = c("factor", rep("numeric",4)))
orders
```
где:

+ "sum.of.sell.price" - золото от продажи всех товаров заказа в амбаре
+ "gold.for.order" - золото за выполнение заказа
+ "xp.for.order" - опыт за выполнение заказа
+ "total.for.order" - сумма gold.for.order и xp.for.order (в данном случае коэф. при слагаемых равны 1 и 1)

***

Посмотрим на взаимосвзязь имеющихся переменных, построив корреляционную матрицу

```{r, echo = TRUE}
cor(orders[, c(2:5)])
```

Т.к. корреляция между "sum.of.sell.price" и "total.for.orderможно" составила 0.998, можно считать, что вознаграждение получаемое от заказа прямопропорционально стоимости продуктов в заказе, если их продать через амбар.

Корреляция между "sum.of.sell.price" и "gold.for.order" и между "sum.of.sell.price" и "xp.for.order" также очень высокая: 0.936 и 0.954 соответственно, на основании чего можно сделать анолочигный предыдущему вывод.

##### c) buy.price
Попробуем выявить формулу для **buy.price** от остальных переменных из файла product_info.csv.

Посчитав несколько моделей наиболее хороший результат (по критерию R2 и AIC) получился в следующей модели:

```{r, echo = FALSE}
products <- read.csv("products.csv", sep = ";", na.strings = "NA", colClasses = c("factor", "factor", rep("numeric",4)))
products <- mutate(products, type.seeds = ifelse(type == "seeds", 1, 0))
```

```{r, echo = TRUE}
model <- lm(data = products, log(buy.price) ~ 0 + log(sell.price) + log(sell.price):type.seeds + log(growth.time))
summary(model)
AIC(model)
coeftest(model, vcov. = vcovHC(model))
```

**Однако сравнив значения построенные по модели с фактическими данными, было принято решение сохранить данную переменную для дальнейшего анализа.**

```{r, echo = TRUE}
cor(cbind(round(exp(fitted(model)), digits = 0), products$buy.price))
head(cbind(round(exp(fitted(model)), digits = 0), products$buy.price))
tail(cbind(round(exp(fitted(model)), digits = 0), products$buy.price))
```

***

#### Другие переменные, которые не попали в анализ

+ **full.growh.time** - время затрачевамое на производство необходимых ингридиентов для товара + плюс время на производство товара
+ **net.sell.price** - разница между продажей в амбаре продукта и суммой продажи в амбаре необходимых для продукта ингридиентов (т.е. чистый доход от производства и продажи товара);
+ **net.buy.price** - разница между покупкой товара за кэш и стоимость покупки необходимых ингридиентов за кэш (т.е. чистая стоимость производства товара за кэш)

Разобравшись в механике игры, можно придти к выводу, что данные переменные являются очень сложными для устного счёта во время игрового процесса, и если и могут служить ориентиром для принятия решения о удалении заказа, то лишь для малой доли игроков. В связи с этим было принято решение не рассчитывать данные переменные.

### 4. Построение модели {#point4}
[начало](#start)

#### **Заказы с какими продуктами игроки удаляют чаще?**

Отвечая на данный вопрос необходимо определиться **что будет являться критерием по частате удаления?** Из вариантов:

+ Сумма удалений продукта (refused)
+ Сумма удалений продукта на количество уровней в группе (refused.per.lvl.in.group)
+ **Сумма удалений продукта на кол-во уровней, которые продукт доступен в игре (refused.per.lvl)**

наиболее рационально использовать последний. Для этого построим сводную таблицу со следующими переменными:

* max.long.avlbl - ...
* type.seeds - ...
* log.sell.price - логарифм натуральный цены продажи в амбаре
* log.buy.price - логарифм натуральный цены покупки за кэш
* log.growth.time - логарифм натуральный времени роста/производсва товара
* refused.per.lvl - какое количество продукта в среднем за уровень удалили за всё время игры с момента ввода товара в игру

```{r, echo=T}
df_2 <- group_by(df, product) %>% summarise(refused = sum(refused), max.long.avlbl = max(max.long.avlbl), log.sell.price = log(mean(sell.price)), log.buy.price = log(mean(buy.price)), log.growth.time = log(mean(growth.time)), type.seeds = mean(type.seeds)) %>% mutate(refused.per.lvl = refused / max.long.avlbl)

df_2$refused.per.lvl[df_2$refused.per.lvl == Inf] <- df_2$refused[df_2$refused.per.lvl == Inf]
```

Выберем 50 товаров наиболее часто удаляемых. А также посмотрим на корреляцию между переменными log.buy.price и log.sell.price.

```{r, echo=T}
df_2 <- df_2[order(df_2$refused.per.lvl, decreasing = T), ][1:50, ]
cor(df_2[, c("log.buy.price", "log.sell.price")])
```

Для построения можели со значимыми коэфициентами необходимо избавиться от мультиколлиниарности в модели, поэтому необходимо ограничиться одной из переменных. Построив разные модели или log.sell.price или log.buy.price переменными, лучшие оценки получились при построении с использованием log.sell.price. Построим модель включив переменные, которые оприорно могут оказывать влияние на количество удалений товара.

```{r, echo=T}
model <- lm(data = df_2, refused.per.lvl ~ max.long.avlbl + log.sell.price + log.growth.time + type.seeds + max.long.avlbl:type.seeds + log.sell.price:type.seeds + log.growth.time:type.seeds)

summary(model)
AIC(model)
coeftest(model, vcov. = vcovHC(model))
```

Переменная **log.growth.time** оказалась незначимой, поэтому удалим её из модели.

```{r, echo=T}
model <- lm(data = df_2, refused.per.lvl ~ max.long.avlbl + log.sell.price + type.seeds + max.long.avlbl:type.seeds + log.sell.price:type.seeds)

summary(model)
AIC(model)
coeftest(model, vcov. = vcovHC(model))
```

Данная модель является значимой. Перейдём к интерпритации результатов.

### 5. Интерпритация коэффициентов, влияющих на среднее количество удалений заказов {#point5}

[начало](#start)

Как видно из модели, все выбранные коэфициенты получились значимыми. Их значения можно трактовать следующим образом:

1. **Кол-во уровней прошедшее с момента появления товара в игре:**

    * **Товары с фабрик**. Чем более недавно появился товар, тем выше вероятность, что его удалят. Т.е. "новые" товары удаляют чаще.
    
    * **Семена**. Учитывая стандартую ошибку при max.long.avlbl и max.long.avlbl:type.seeds нельзя точно сказать, уменьшает ли "новизна" продукта вероятность быть удалённым. Что является логичным в связи с тем, что препятсвий произвести данный продукт гораздо меньше, чем для товаров с фабрик. В то же время, если уровень значимости уменьшить, мы получаем вывод о том, что чем более давно появились семена, тем вероятнее удалят этот заказ, что также логично и не противоречит первому выводу, так как более ранние семена как правило стоят мало и их меньше производят, а могу купить, например, на рынке.
    
2. **Тип товара**. Как видно, если продукт отновится к типу "Семена", то количество удалений в среднем данного заказа значительно меньше.
    
3. **Стоимость продажи в амбаре**
    
    * **Товары с фабрик**. Чем выше цена продажи в амбаре, тем, как выяснилось, выше величина вознаграждения за заказ и тем реже удаляют товар. В тоже время нужно помнить о высокой корреляции log.sell.price с log.buy.price. Из этой взаимосвязи может напрашиваться вывод о том, что чем выше стоимость покупки за кэш, тем реже удаляют заказ.
    
    * **Семена**. Чем выше цена продажи семян в амбаре, тем больше удалений заказа наблюдается для семян (сумма коэффициентов log.sell.price + log.sell.price:type.seeds). Но также как и в случае с товарами с фабрик стоит вспомнить о высокой корреляции с ценой покупки за кэш. 
    
    **Вывод:** Из данного противоречия остаётся предположить, что:
    
    а) для семян *цена покупки за кэш* имеет большее значение при удалении товара, чем цена продажи в амбаре. И поэтому чем выше цена покупки за кэш, тем чаще удаляют товар. Это можно объяснить тем, что семена произвести гораздо проще, чем покупать их за кэш.
    
    б) для товаров с фабрик важнее цена стоимости продажи в амбаре и, как следствие, вознаграждение за заказ. Поэтому чем выше цена продажи и чем выше вознаграждение за заказ, тем реже будут удалять такой заказ.